name: delineate

services:
  # API Service
  delineate-app:
    build:
      context: ..
      dockerfile: docker/Dockerfile.prod
    ports:
      - "3000:3000"
    env_file:
      - ../.env
    environment:
      - NODE_ENV=production
      - S3_ENDPOINT=http://delineate-rustfs:9000
      - S3_ACCESS_KEY_ID=rustfsadmin
      - S3_SECRET_ACCESS_KEY=rustfsadmin
      - S3_BUCKET_NAME=downloads
      - S3_FORCE_PATH_STYLE=true
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://otel-collector:4318
    depends_on:
      - delineate-rustfs-init
      - otel-collector
    restart: unless-stopped
    networks:
      - delineate-network

  # S3 Storage (RustFS)
  delineate-rustfs:
    image: rustfs/rustfs:latest
    container_name: delineate-rustfs
    ports:
      - "9000:9000"
      - "9001:9001"
    volumes:
      - rustfs-data:/data
      - rustfs-logs:/logs
    environment:
      - RUSTFS_ROOT_USER=rustfsadmin
      - RUSTFS_ROOT_PASSWORD=rustfsadmin
    user: "10001:10001"
    restart: unless-stopped
    networks:
      - delineate-network

  delineate-rustfs-init:
    image: amazon/aws-cli:latest
    container_name: delineate-rustfs-init
    entrypoint: ["/bin/sh", "-c"]
    command:
      - |
        echo "Waiting for RustFS to be ready..."
        until curl -s -o /dev/null -w "%{http_code}" http://delineate-rustfs:9000 | grep -qE "^(200|403|404)"; do
          echo "RustFS is not ready yet. Waiting..."
          sleep 2
        done
        echo "RustFS is ready. Creating bucket..."
        aws --endpoint-url=http://delineate-rustfs:9000 \
          --region=us-east-1 \
          s3 mb s3://downloads || echo "Bucket may already exist"
        echo "Bucket 'downloads' created successfully!"
    depends_on:
      delineate-rustfs:
        condition: service_started
    environment:
      - AWS_ACCESS_KEY_ID=rustfsadmin
      - AWS_SECRET_ACCESS_KEY=rustfsadmin
      - AWS_DEFAULT_REGION=us-east-1
    networks:
      - delineate-network

  # OpenTelemetry Collector
  otel-collector:
    image: otel/opentelemetry-collector-contrib:latest
    container_name: otel-collector
    command: ["--config=/etc/otel-collector-config.yml"]
    volumes:
      - ./otel-collector-config.yml:/etc/otel-collector-config.yml
    ports:
      - "4317:4317"  # OTLP gRPC
      - "4318:4318"  # OTLP HTTP
    depends_on:
      - prometheus
      - elasticsearch
    restart: unless-stopped
    networks:
      - delineate-network

  # Prometheus (Metrics)
  prometheus:
    image: prom/prometheus:latest
    container_name: prometheus
    ports:
      - "9092:9090"
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml
      - prometheus-data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.console.libraries=/usr/share/prometheus/console_libraries'
      - '--web.console.templates=/usr/share/prometheus/consoles'
      - '--storage.tsdb.retention.time=15d'
    restart: unless-stopped
    networks:
      - delineate-network

  # Elasticsearch (Logs & Traces)
  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:8.11.0
    container_name: elasticsearch
    environment:
      - discovery.type=single-node
      - xpack.security.enabled=false
      - "ES_JAVA_OPTS=-Xms512m -Xmx512m"
      - bootstrap.memory_lock=true
    ulimits:
      memlock:
        soft: -1
        hard: -1
    volumes:
      - elasticsearch-data:/usr/share/elasticsearch/data
    ports:
      - "9200:9200"
      - "9300:9300"
    restart: unless-stopped
    networks:
      - delineate-network
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:9200/_cluster/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5

  # Filebeat (Log Shipper to Elasticsearch)
  # Note: Filebeat requires root ownership of config file
  # To enable: sudo chown root:root docker/filebeat.yml && sudo chmod 644 docker/filebeat.yml
  # For now, logs are shipped via OpenTelemetry Collector
  # filebeat:
  #   image: docker.elastic.co/beats/filebeat:8.11.0
  #   container_name: filebeat
  #   user: root
  #   volumes:
  #     - ./filebeat.yml:/usr/share/filebeat/filebeat.yml:ro
  #     - /var/lib/docker/containers:/var/lib/docker/containers:ro
  #     - /var/run/docker.sock:/var/run/docker.sock:ro
  #   command: ["--strict.perms=false"]
  #   depends_on:
  #     - elasticsearch
  #   restart: unless-stopped
  #   networks:
  #     - delineate-network

  # Kibana (Logs & Traces Visualization)
  kibana:
    image: docker.elastic.co/kibana/kibana:8.11.0
    container_name: kibana
    ports:
      - "5601:5601"
    environment:
      - ELASTICSEARCH_HOSTS=http://elasticsearch:9200
      - ELASTICSEARCH_USERNAME=kibana_system
      - ELASTICSEARCH_PASSWORD=
      - XPACK_SECURITY_ENABLED=false
    depends_on:
      - elasticsearch
    restart: unless-stopped
    networks:
      - delineate-network
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:5601/api/status || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5

  # Grafana (Metrics Dashboards)
  grafana:
    image: grafana/grafana:latest
    container_name: grafana
    ports:
      - "3001:3000"
    environment:
      - GF_SECURITY_ADMIN_USER=admin
      - GF_SECURITY_ADMIN_PASSWORD=admin
      - GF_AUTH_ANONYMOUS_ENABLED=true
      - GF_AUTH_ANONYMOUS_ORG_ROLE=Admin
    volumes:
      - grafana-data:/var/lib/grafana
      - ./grafana/provisioning:/etc/grafana/provisioning
    depends_on:
      - prometheus
      - loki
      - jaeger
    restart: unless-stopped
    networks:
      - delineate-network

  # Jaeger (Distributed Tracing)
  jaeger:
    image: jaegertracing/all-in-one:latest
    container_name: jaeger
    ports:
      - "16686:16686"  # Jaeger UI
      - "14268:14268"  # Jaeger HTTP collector
    environment:
      - COLLECTOR_OTLP_ENABLED=true
    restart: unless-stopped
    networks:
      - delineate-network

  # Loki (Log Aggregation)
  loki:
    image: grafana/loki:latest
    container_name: loki
    ports:
      - "3100:3100"
    command: -config.file=/etc/loki/local-config.yaml
    volumes:
      - ./loki-config.yml:/etc/loki/local-config.yaml:ro
      - loki-data:/loki
    restart: unless-stopped
    networks:
      - delineate-network

  # Promtail (Log Shipper to Loki)
  promtail:
    image: grafana/promtail:latest
    container_name: promtail
    volumes:
      - ./promtail-config.yml:/etc/promtail/config.yml:ro
      - /var/lib/docker/containers:/var/lib/docker/containers:ro
      - /var/run/docker.sock:/var/run/docker.sock:ro
    command: -config.file=/etc/promtail/config.yml
    depends_on:
      - loki
    restart: unless-stopped
    networks:
      - delineate-network

volumes:
  rustfs-data:
  rustfs-logs:
  prometheus-data:
  elasticsearch-data:
  grafana-data:
  loki-data:

networks:
  delineate-network:
    driver: bridge
